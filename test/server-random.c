#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <unistd.h>
#include <netinet/in.h>
#include <arpa/inet.h>

#define PORT 8080
#define MAX_CLIENTS 10

typedef struct {
    int socket;
    int id;
    char ip[INET_ADDRSTRLEN];
} ClientInfo;

ClientInfo clients[MAX_CLIENTS] = {{0}};
int nextClientId = 1;
int selectedClientId = -1;  // ID du client actuellement sélectionné, -1 si aucun

void die(const char *msg) {
    perror(msg);
    exit(EXIT_FAILURE);
}

void handleNewConnection(int server_fd) {
    printf("En attente d'une nouvelle connexion...\n");
    struct sockaddr_in address;
    int addrlen = sizeof(address);
    int new_socket = accept(server_fd, (struct sockaddr *)&address, (socklen_t*)&addrlen);
    if (new_socket < 0) {
        die("accept");
    }

    char client_ip[INET_ADDRSTRLEN];
    inet_ntop(AF_INET, &address.sin_addr, client_ip, INET_ADDRSTRLEN);
    printf("Nouveau client connecté, socket fd: %d, id: %d, IP: %s\n\n", new_socket, nextClientId, client_ip);

    for (int i = 0; i < MAX_CLIENTS; i++) {
        if (clients[i].socket == 0) {
            clients[i].socket = new_socket;
            clients[i].id = nextClientId;
            strcpy(clients[i].ip, client_ip);
            printf("Client %d ajouté avec succès.\n", nextClientId);
            break;
        }
    }

    nextClientId++;
}

void sendHelloToClient(int client_id) {
    printf("Envoi de 'Bonjour' au client %d...\n", client_id);
    for (int i = 0; i < MAX_CLIENTS; i++) {
        if (clients[i].id == client_id && clients[i].socket != 0) {
            char *message = "Bonjour\n";
            send(clients[i].socket, message, strlen(message), 0);
            printf("Message 'Bonjour' envoyé au client %d\n", client_id);
            return;
        }
    }
    printf("Aucun client avec cet ID\n");
}

void afficherClientsActifs() {
    printf("Clients actifs:\n\n");
    for (int i = 0; i < MAX_CLIENTS; i++) {
        if (clients[i].socket != 0) {
            printf("ID: %d, IP: %s\n", clients[i].id, clients[i].ip);
        }
    }
}

void afficherMenu() {
    if (selectedClientId != -1) {
        printf("\n\n\n\n\n");
        printf(",----. ,--.         ,--. \n");
        printf("'.-.  |`--',--,--, /   | \n");
        printf("  .'< , --.|      \\`|  | \n");
        printf("/'-'  ||  ||  ||  | |  | \n");
        printf("`----' `--'`--''--' `--' \n\n");
        printf("\n--- Client actuellement sélectionné: ID %d --\n", selectedClientId);
    } else {
        printf("\n\n\n\n\n");
        printf(",----. ,--.         ,--. \n");
        printf("'.-.  |`--',--,--, /   | \n");
        printf("  .'< , --.|      \\`|  | \n");
        printf("/'-'  ||  ||  ||  | |  | \n");
        printf("`----' `--'`--''--' `--' \n\n");
        printf("\n--- Aucun client actuellement sélectionné ---");
    }
    printf("\n\n Attention cliquer sur 'Nouveau client' avant d'executer le script coté client !");
    printf("\n\n1. Nouveau client\n2. Choisir client\n3. Envoyer 'Bonjour'\n4. Quitter\n\nVotre choix: ");
}

int main() {
    printf("Démarrage du serveur sur le port %d...\n", PORT);
    int server_fd, opt = 1;
    struct sockaddr_in address;

    if ((server_fd = socket(AF_INET, SOCK_STREAM, 0)) == 0) {
        die("socket failed");
    }

    if (setsockopt(server_fd, SOL_SOCKET, SO_REUSEADDR, &opt, sizeof(opt))) {
        die("setsockopt");
    }

    address.sin_family = AF_INET;
    address.sin_addr.s_addr = INADDR_ANY;
    address.sin_port = htons(PORT);

    if (bind(server_fd, (struct sockaddr *)&address, sizeof(address)) < 0) {
        die("bind failed");
    }

    if (listen(server_fd, MAX_CLIENTS) < 0) {
        die("listen");
    }

    printf("Serveur en écoute sur le port %d...\n", PORT);
    int running = 1;
    while (running) {
        afficherMenu();
        int choice;
        scanf("%d", &choice);

        switch (choice) {
            case 1:
                handleNewConnection(server_fd);
                break;
            case 2:
                afficherClientsActifs();
                printf("\nEntrer l'ID du client: ");
                scanf("%d", &selectedClientId);
                break;
            case 3:
                if (selectedClientId != -1) {
                    sendHelloToClient(selectedClientId);
                } else {
                    printf("Veuillez d'abord sélectionner un client.\n");
                }
                break;
            case 4:
                printf("Arrêt du serveur...\n");
                running = 0;
                break;
            default:
                printf("Choix invalide\n");
        }
    }

    for (int i = 0; i < MAX_CLIENTS; i++) {
        if (clients[i].socket != 0) {
            close(clients[i].socket);
        }
    }

    close(server_fd);
    return 0;
}
