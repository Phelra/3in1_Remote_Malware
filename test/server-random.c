#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <unistd.h>
#include <netinet/in.h>
#include <sys/select.h>

#define PORT 8080
#define MAX_CLIENTS 10

int client_sockets[MAX_CLIENTS] = {0}; // Tableau de sockets clients
int clientId = 1; // ID de client, incrémenté à chaque nouvelle connexion

void die(const char *msg) {
    perror(msg);
    exit(EXIT_FAILURE);
}

void handleNewConnection(int server_fd) {
    struct sockaddr_in address;
    int addrlen = sizeof(address);
    int new_socket = accept(server_fd, (struct sockaddr *)&address, (socklen_t*)&addrlen);
    if (new_socket < 0) {
        die("accept");
    }

    printf("Nouveau client connecté, socket fd: %d, id: %d\n", new_socket, clientId);

    // Ajouter le nouveau socket client au tableau
    for (int i = 0; i < MAX_CLIENTS; i++) {
        if (client_sockets[i] == 0) {
            client_sockets[i] = new_socket;
            break;
        }
    }

    clientId++;
}

void sendHelloToClient(int client_id) {
    if (client_id < 1 || client_id >= clientId) {
        printf("ID client invalide\n");
        return;
    }

    int socket = client_sockets[client_id - 1];
    if (socket == 0) {
        printf("Aucun client avec cet ID\n");
        return;
    }

    char *message = "Bonjour\n";
    send(socket, message, strlen(message), 0);
    printf("Message 'Bonjour' envoyé au client %d\n", client_id);
}

int main() {
    int server_fd;
    struct sockaddr_in address;
    int opt = 1;

    if ((server_fd = socket(AF_INET, SOCK_STREAM, 0)) == 0) {
        die("socket failed");
    }

    if (setsockopt(server_fd, SOL_SOCKET, SO_REUSEADDR, &opt, sizeof(opt))) {
        die("setsockopt");
    }

    address.sin_family = AF_INET;
    address.sin_addr.s_addr = INADDR_ANY;
    address.sin_port = htons(PORT);

    if (bind(server_fd, (struct sockaddr *)&address, sizeof(address)) < 0) {
        die("bind failed");
    }

    if (listen(server_fd, MAX_CLIENTS) < 0) {
        die("listen");
    }

    printf("Serveur en écoute sur le port %d...\n", PORT);

    int running = 1;
    while (running) {
        printf("\nMenu:\n1. Nouveau client\n2. Choisir client\n3. Envoyer 'Bonjour'\n4. Quitter\nVotre choix: ");
        int choice;
        scanf("%d", &choice);

        switch (choice) {
            case 1:
                handleNewConnection(server_fd);
                break;
            case 2: {
                printf("Entrer l'ID du client: ");
                int id;
                scanf("%d", &id);
                sendHelloToClient(id);
                break;
            }
            case 3:
                sendHelloToClient(clientId - 1);
                break;
            case 4:
                running = 0;
                break;
            default:
                printf("Choix invalide\n");
        }
    }

    close(server_fd);
    return 0;
}
