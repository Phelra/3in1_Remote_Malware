#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <openssl/evp.h>
#include <openssl/rand.h>
#include <dirent.h>
#include <sys/stat.h>

#define AES_KEY_SIZE 256

void handleErrors(void)
{
    fprintf(stderr, "Erreur OpenSSL\n");
    exit(1);
}

void encrypt_decrypt_file(const char *input_file, const char *output_file, const char *key, int do_encrypt)
{
    // Le code pour chiffrer/déchiffrer un fichier est le même que précédemment
    // ...

}

void encrypt_decrypt_directory(const char *dir_path, const char *key, int do_encrypt)
{
    DIR *dir = opendir(dir_path);
    if (dir == NULL)
    {
        perror("Erreur lors de l'ouverture du répertoire");
        exit(1);
    }

    struct dirent *entry;
    while ((entry = readdir(dir)) != NULL)
    {
        char file_path[PATH_MAX];
        snprintf(file_path, PATH_MAX, "%s/%s", dir_path, entry->d_name);

        struct stat stat_buf;
        if (stat(file_path, &stat_buf) == -1)
        {
            perror("Erreur lors de la récupération des informations du fichier");
            continue;
        }

        if (S_ISREG(stat_buf.st_mode) && strcmp(entry->d_name, "votre_programme") != 0)
        {
            // Chiffrer/déchiffrer uniquement les fichiers réguliers (ignorer le programme)
            encrypt_decrypt_file(file_path, file_path, key, do_encrypt);
        }
        else if (S_ISDIR(stat_buf.st_mode) && strcmp(entry->d_name, ".") != 0 && strcmp(entry->d_name, "..") != 0)
        {
            // Récursivement chiffrer/déchiffrer les sous-répertoires
            encrypt_decrypt_directory(file_path, key, do_encrypt);
        }
    }

    closedir(dir);
}

int main()
{
    char choice;
    char key[32];

    printf("Entrez la clé (256 bits) : ");
    fgets(key, sizeof(key), stdin);
    key[strlen(key) - 1] = '\0';

    printf("Menu:\n");
    printf("1. Chiffrer le répertoire home (à l'exception du programme)\n");
    printf("2. Déchiffrer le répertoire home (à l'exception du programme)\n");
    printf("Choisissez une option (1/2) : ");
    scanf(" %c", &choice);

    char *home_dir = getenv("HOME");
    if (home_dir == NULL)
    {
        fprintf(stderr, "Impossible d'obtenir le répertoire home de l'utilisateur.\n");
        return 1;
    }

    if (choice == '1')
    {
        encrypt_decrypt_directory(home_dir, key, 1);
        printf("Chiffrement terminé.\n");
    }
    else if (choice == '2')
    {
        encrypt_decrypt_directory(home_dir, key, 0);
        printf("Déchiffrement terminé.\n");
    }
    else
    {
        printf("Choix non valide.\n");
        return 1;
    }

    return 0;
}
